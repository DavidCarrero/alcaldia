@*
    Dropdown Multi-Select con Búsqueda
    Parámetros:
    - fieldName: Nombre del campo
    - label: Etiqueta
    - options: Lista de opciones (IEnumerable con Id, Text)
    - selectedValues: Lista de valores seleccionados
    - placeholder: Texto placeholder
    - required: Si es requerido
    - icon: Icono FontAwesome
*@

@{
    var fieldName = ViewData["fieldName"]?.ToString() ?? "FieldIds";
    var label = ViewData["label"]?.ToString() ?? "Seleccionar";
    var options = ViewData["options"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var selectedValues = ViewData["selectedValues"] as List<int> ?? new List<int>();
    var placeholder = ViewData["placeholder"]?.ToString() ?? "Buscar y seleccionar opciones";
    var required = ViewData["required"]?.ToString() == "True";
    var icon = ViewData["icon"]?.ToString() ?? "fa-list";
    
    var optionsList = options.ToList();
    var componentId = $"ddm{Guid.NewGuid():N}";
}

<script>
    window['@(componentId)_opts'] = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        optionsList.Select(o => new { 
            id = Convert.ToInt32(o.Id), 
            text = o.Text?.ToString() ?? "" 
        }).ToList()
    ));
    window['@(componentId)_sels'] = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(selectedValues ?? new List<int>()));
</script>

<div class="col-12">
    <label class="form-label fw-bold">
        <i class="fas @icon me-1"></i>
        @label
        @if (required)
        {
            <span class="text-danger">*</span>
        }
    </label>
    
    <div x-data="{
        searchTerm: '',
        showDropdown: false,
        selectedIds: window['@(componentId)_sels'] || [],
        options: window['@(componentId)_opts'] || [],
        hiddenInputsId: 'hidden_@componentId',
        
        get filteredOptions() {
            if (!this.searchTerm) return this.options;
            const term = this.searchTerm.toLowerCase();
            return this.options.filter(opt => opt.text.toLowerCase().includes(term));
        },
        
        get selectedOptions() {
            return this.options.filter(opt => this.selectedIds.includes(opt.id));
        },
                
        toggleOption(id) {
            const index = this.selectedIds.indexOf(id);
            if (index > -1) {
                this.selectedIds.splice(index, 1);
            } else {
                this.selectedIds.push(id);
            }
        },
        
        removeOption(id) {
            const index = this.selectedIds.indexOf(id);
            if (index > -1) {
                this.selectedIds.splice(index, 1);
            }
        },
        
        isSelected(id) {
            return this.selectedIds.includes(id);
        },
        
        clearAll() {
            this.selectedIds = [];
            this.searchTerm = '';
        }
    }"
    @@click.away="showDropdown = false"
    class="dropdown w-100">
        <button class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center" 
                type="button" 
                @@click="showDropdown = !showDropdown"
                :class="{ 'btn-outline-primary': selectedIds.length > 0 }">
            <span>
                <i class="fas @icon me-2"></i>
                <span x-text="selectedIds.length > 0 ? selectedIds.length + ' seleccionado(s)' : '@placeholder'"></span>
            </span>
            <i class="fas fa-chevron-down ms-2"></i>
        </button>
        
        <div class="dropdown-menu w-100 shadow-lg border" 
             :class="{ 'show': showDropdown }"
             style="max-height: 400px; overflow-y: auto;">
            
            <!-- Campo de búsqueda -->
            <div class="px-3 py-2 border-bottom sticky-top bg-white">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" 
                           class="form-control border-start-0 ps-0" 
                           x-model="searchTerm"
                           @@keydown.escape="showDropdown = false"
                           placeholder="Buscar..."
                           autocomplete="off"
                           x-ref="searchInput" />
                </div>
            </div>
            
            <!-- Opciones -->
            <template x-for="option in filteredOptions" :key="option.id">
                <a href="#" 
                   class="dropdown-item d-flex align-items-center py-2"
                   :class="{ 'bg-primary text-white': isSelected(option.id) }"
                   @@click.prevent="toggleOption(option.id)">
                    <i class="fas @icon me-2" :class="{ 'text-white': isSelected(option.id), 'text-primary': !isSelected(option.id) }"></i>
                    <span class="flex-grow-1" x-text="option.text"></span>
                </a>
            </template>
            
            <div x-show="filteredOptions.length === 0" 
                 class="dropdown-item-text text-muted text-center py-3">
                <i class="fas fa-search me-2"></i>No se encontraron resultados
            </div>
            
            <!-- Limpiar selección -->
            <div x-show="selectedIds.length > 0" class="border-top">
                <a href="#" 
                   class="dropdown-item text-danger text-center py-2"
                   @@click.prevent="clearAll()">
                    <i class="fas fa-times me-2"></i>Limpiar selección
                </a>
            </div>
        </div>
        
        <!-- Hidden inputs generados con Alpine.js template -->
        <template x-for="id in selectedIds" :key="id">
            <input type="hidden" name="@fieldName" :value="id">
        </template>
    </div>
    
    <span class="field-validation-valid text-danger small mt-1 d-block" 
          data-valmsg-for="@fieldName" 
          data-valmsg-replace="true"></span>
    
    <!-- Listado de opciones seleccionadas -->
    <div class="mt-3" x-show="selectedOptions.length > 0" x-cloak>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted fw-bold">
                <i class="fas fa-check-circle me-1"></i>
                <span x-text="selectedOptions.length"></span> seleccionado(s)
            </small>
            <button type="button" 
                    class="btn btn-sm btn-outline-danger"
                    @@click="clearAll()">
                <i class="fas fa-times me-1"></i>Limpiar todo
            </button>
        </div>
        
        <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;">
            <template x-for="option in selectedOptions" :key="option.id">
                <div class="d-flex align-items-center justify-content-between p-2 mb-1 bg-white rounded shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class="fas @icon me-2 text-primary"></i>
                        <span x-text="option.text"></span>
                    </div>
                    <button type="button" 
                            class="btn btn-sm btn-link text-danger p-0"
                            @@click="removeOption(option.id)"
                            title="Eliminar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
</style>
