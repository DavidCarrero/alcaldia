@model IEnumerable<Proyecto_alcaldia.Application.ViewModels.SubsecretariaViewModel>

@{
    ViewData["Title"] = "Gestión de Subsecretarías";
    Layout = "_LayoutDashboard";
}

<main class="container-fluid" x-data="responsablesManager()">
    @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)> {
        ("Estructura Organizacional", null),
        ("Subsecretarías", null)
    })

    <!-- Encabezado con Icono -->
    <header class="page-header mb-4">
        <div class="page-header-icon">
            <i class="fas fa-sitemap"></i>
        </div>
        <div class="page-header-content flex-grow-1">
            <h2>Gestión de Subsecretarías</h2>
            <p class="text-muted">Administración de subsecretarías por secretaría</p>
        </div>
        <div>
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Nueva Subsecretaría
            </a>
        </div>
    </header>

    <!-- Tarjetas de Estadísticas -->
    <section class="row g-4 mb-4" aria-label="Estadísticas de subsecretarías">
        <div class="col-xl-4 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-gradient rounded-3 p-3 text-white">
                                <i class="fas fa-building fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Total Subsecretarías</h6>
                            <h3 class="mb-0 fw-bold">@ViewBag.TotalActivas</h3>
                            <small class="text-primary">Activas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-gradient rounded-3 p-3 text-white">
                                <i class="fas fa-user-check fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Con Responsable</h6>
                            <h3 class="mb-0 fw-bold">@ViewBag.ConResponsable</h3>
                            <small class="text-success">Asignados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-gradient rounded-3 p-3 text-white">
                                <i class="fas fa-briefcase fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Secretarías</h6>
                            <h3 class="mb-0 fw-bold">@ViewBag.Secretarias</h3>
                            <small class="text-info">Categorías</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tabla de Subsecretarías -->
    <section class="card border-0 shadow-sm" aria-label="Listado de subsecretarías">
        <div class="card-header bg-white py-3">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Lista de Subsecretarías</h5>
                </div>
            </div>
        </div>
        <div class="card-body">
            <form asp-action="Index" method="get" id="searchForm" class="mb-3">
                <input type="hidden" name="pageSize" value="@(ViewBag.PageSize ?? 5)" />
                <div class="input-group">
                    <input type="text" 
                           name="searchTerm" 
                           class="form-control" 
                           placeholder="Buscar por nombre o código..."
                           value="@ViewData["SearchTerm"]">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
            </form>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Secretarías</th>
                            <th>Responsable</th>
                            <th>Presupuesto</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Any())
                        {
                            @foreach (var subsecretaria in Model)
                            {
                                <tr>
                                    <td><span class="badge badge-gradient bg-primary">@subsecretaria.Codigo</span></td>
                                    <td>
                                        <div class="fw-bold">@subsecretaria.Nombre</div>
                                        @if (!string.IsNullOrEmpty(subsecretaria.Descripcion))
                                        {
                                            <small class="text-muted">@subsecretaria.Descripcion</small>
                                        }
                                    </td>
                                    <td>
                                        @if (subsecretaria.SecretariasNombres != null && subsecretaria.SecretariasNombres.Any())
                                        {
                                            @foreach (var secretaria in subsecretaria.SecretariasNombres)
                                            {
                                                <span class="badge bg-info me-1 mb-1">@secretaria</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Sin asignar</span>
                                        }
                                    </td>
                                    <td>
                                        @if (subsecretaria.ResponsablesNombres != null && subsecretaria.ResponsablesNombres.Any())
                                        {
                                            <button type="button" 
                                                    class="btn btn-outline-success btn-sm position-relative" 
                                                    onclick="window.responsablesApp.mostrarResponsables(@subsecretaria.Id, '@subsecretaria.Nombre')"
                                                    data-bs-toggle="tooltip" 
                                                    data-bs-placement="top" 
                                                    title="Click para ver detalles">
                                                <i class="fas fa-users me-1"></i>
                                                @subsecretaria.ResponsablesNombres.Count Responsable@(subsecretaria.ResponsablesNombres.Count != 1 ? "s" : "")
                                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                                    @subsecretaria.ResponsablesNombres.Count
                                                </span>
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-muted border">
                                                <i class="fas fa-user-slash me-1"></i>Sin asignar
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @if (subsecretaria.PresupuestoAsignado.HasValue)
                                        {
                                            <span class="text-success fw-bold">@subsecretaria.PresupuestoAsignado.Value.ToString("C0")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (subsecretaria.Activo)
                                        {
                                            <span class="badge bg-success">Activo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactivo</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <a asp-action="Edit" asp-route-id="@subsecretaria.Id" 
                                               class="btn-action btn-edit" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn-action btn-delete" 
                                                    onclick="confirmDelete('@Url.Action("Delete", "Subsecretarias", new { id = subsecretaria.Id })', '@subsecretaria.Nombre', '@Url.Action("Index", "Subsecretarias")')"
                                                    title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <i class="fas fa-sitemap fa-4x text-muted mb-3 d-block"></i>
                                    <h5 class="text-muted">No hay resultados</h5>
                                    @if (!string.IsNullOrWhiteSpace(ViewData["SearchTerm"]?.ToString()))
                                    {
                                        <p class="text-muted mb-3">No se encontraron subsecretarías que coincidan con "<strong>@ViewData["SearchTerm"]</strong>"</p>
                                        <a asp-action="Index" class="btn btn-outline-primary">
                                            <i class="fas fa-times me-1"></i>Limpiar búsqueda
                                        </a>
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-3">No hay subsecretarías registradas. Comience creando un nuevo registro.</p>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            @await Html.PartialAsync("_Pagination")
        </div>
    </section>
</main>

<!-- Modal de Responsables -->
<div class="modal fade" id="modalResponsables" tabindex="-1" aria-labelledby="modalResponsablesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalResponsablesLabel">
                    <i class="fas fa-users me-2"></i>Responsables Asignados
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="text-muted mb-2">Subsecretaría:</h6>
                    <h5 x-text="subsecretariaNombre" class="text-primary"></h5>
                </div>
                <hr>
                
                <!-- Loading State -->
                <template x-if="loading && !error">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando responsables...</p>
                    </div>
                </template>

                <!-- Error State -->
                <template x-if="error">
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h6 class="text-warning">Error al cargar responsables</h6>
                        <p class="small text-muted" x-text="errorMessage"></p>
                    </div>
                </template>

                <!-- Sin Responsables -->
                <template x-if="!loading && !error && responsables.length === 0">
                    <div class="text-center py-4">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No hay responsables asignados</h6>
                    </div>
                </template>

                <!-- Lista de Responsables -->
                <template x-if="!loading && !error && responsables.length > 0">
                    <div class="row">
                    <template x-for="responsable in responsables" :key="responsable.Id">
                        <div class="col-md-6 mb-3">
                            <div class="card border-start border-3 h-100"
                                 :class="responsable.TipoResponsable === 'Funcionario' ? 'border-primary' : 'border-info'">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <div class="avatar-circle text-white me-3"
                                             :class="responsable.TipoResponsable === 'Funcionario' ? 'bg-primary' : 'bg-info'">
                                            <i :class="responsable.TipoResponsable === 'Funcionario' ? 'fas fa-user-tie' : 'fas fa-user'"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1"
                                                :class="responsable.TipoResponsable === 'Funcionario' ? 'text-primary' : 'text-info'"
                                                x-text="responsable.NombreCompleto || responsable.nombreCompleto || 'Sin nombre'"></h6>
                                            <div class="small text-muted mb-2">
                                                <div class="mb-1">
                                                    <i class="fas fa-id-card me-1"></i>
                                                    <strong>ID:</strong> <span x-text="responsable.NumeroIdentificacion || responsable.numeroIdentificacion || 'Sin número'"></span>
                                                </div>
                                                <div class="mb-1">
                                                    <i class="fas fa-hashtag me-1"></i>
                                                    <strong>Código:</strong> 
                                                    <span class="badge bg-secondary" x-text="responsable.Id || responsable.id || 'N/A'"></span>
                                                </div>
                                                <div x-show="responsable.Cargo || responsable.cargo" class="mb-1">
                                                    <i class="fas fa-briefcase me-1"></i>
                                                    <strong>Cargo:</strong> <span x-text="responsable.Cargo || responsable.cargo"></span>
                                                </div>
                                                <div x-show="responsable.Email || responsable.email" class="mb-1">
                                                    <i class="fas fa-envelope me-1"></i>
                                                    <strong>Email:</strong> 
                                                    <a :href="'mailto:' + (responsable.Email || responsable.email)" 
                                                       class="text-decoration-none" 
                                                       x-text="responsable.Email || responsable.email"></a>
                                                </div>
                                                <div x-show="responsable.Telefono || responsable.telefono" class="mb-1">
                                                    <i class="fas fa-phone me-1"></i>
                                                    <strong>Teléfono:</strong> 
                                                    <a :href="'tel:' + (responsable.Telefono || responsable.telefono)" 
                                                       class="text-decoration-none" 
                                                       x-text="responsable.Telefono || responsable.telefono"></a>
                                                </div>
                                            </div>
                                            <span class="badge"
                                                  :class="(responsable.TipoResponsable || responsable.tipoResponsable) === 'Funcionario' ? 'bg-primary-subtle text-primary' : 'bg-info-subtle text-info'">
                                                <i :class="(responsable.TipoResponsable || responsable.tipoResponsable) === 'Funcionario' ? 'fas fa-user-tie me-1' : 'fas fa-user me-1'"></i>
                                                <span x-text="responsable.TipoResponsable || responsable.tipoResponsable || 'General'"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    </div>
                </template>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function responsablesManager() {
    return {
        loading: false,
        error: false,
        errorMessage: '',
        responsables: [],
        subsecretariaNombre: '',
        modal: null,

        async mostrarResponsables(subsecretariaId, nombreSubsecretaria) {
            this.subsecretariaNombre = nombreSubsecretaria;
            this.loading = true;
            this.error = false;
            this.responsables = [];
            
            // Abrir el modal
            if (!this.modal) {
                this.modal = new bootstrap.Modal(document.getElementById('modalResponsables'));
            }
            this.modal.show();

            try {
                console.log('Cargando responsables para ID:', subsecretariaId);
                const response = await fetch(`/Subsecretarias/GetResponsables/${subsecretariaId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                console.log('Tipo de data:', typeof data, 'Es array:', Array.isArray(data), 'Longitud:', data?.length);
                
                if (data && Array.isArray(data)) {
                    this.responsables = data;
                    console.log('Responsables asignados:', this.responsables);
                } else {
                    console.warn('Datos recibidos no son un array:', data);
                    this.responsables = [];
                }
                
                this.loading = false;
                
            } catch (error) {
                console.error('Error al cargar responsables:', error);
                this.loading = false;
                this.error = true;
                this.errorMessage = error.message;
            }
        }
    }
}

// Hacer la función globalmente accesible
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Alpine.js app
    const app = responsablesManager();
    window.responsablesApp = app;
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1em;
    flex-shrink: 0;
}

.bg-primary-subtle {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.bg-info-subtle {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

/* Efectos de hover en las cards */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

/* Efecto en las filas de la tabla */
.table tbody tr {
    transition: all 0.2s ease;
}

.table tbody tr:hover {
    background-color: var(--theme-primary-light, rgba(13, 110, 253, 0.05));
    transform: scale(1.01);
}

/* Botones de acción */
.btn-action {
    transition: all 0.2s ease;
}

.btn-action:hover {
    transform: scale(1.15);
}

/* Animación de badges en hover */
.table tbody tr td .badge {
    transition: all 0.3s ease;
}

.table tbody tr:hover td .badge {
    transform: scale(1.05);
}
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
}
